ðŸ“†: 2022-05-25 13:35:51
ðŸ·: #æ»šåŠ¨åŠ è½½ #æ‡’åŠ è½½ 

## ä¸€ã€scrollè®¡ç®—

æ€è·¯ï¼šé€šè¿‡æ»šåŠ¨æ¡åˆ¤æ–­æ˜¯å¦åˆ°å†…å®¹åº•éƒ¨ => åˆ°åº•éƒ¨åŽå‘åŽå°è¯·æ±‚ä¸‹ä¸€é¡µå¾—æ•°æ® => å°†è¯·æ±‚å¾—æ–°æ•°æ®æ‹¼æŽ¥åœ¨è€æ•°æ®ä¸Š

ä¸‰ä¸ªå…³é”®ç‚¹ï¼š

1. æ»šåŠ¨æ¡è·ç¦»é¡¶éƒ¨çš„è·ç¦»ï¼š`document.documentElement.scrollTop`||`document.body.scrollTop`
2. å½“å‰çª—å£å†…å®¹çš„å¯è§†åŒºåŸŸï¼š`document.documentElement.clientHeight` || `document.body.clientHeigh`
3. æ»šåŠ¨æ¡å†…å®¹çš„æ€»é«˜åº¦ï¼š`document.documentElement.scrollHeight`||`document.body.scrollHeight`

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®žé™…ä¸Šï¼Œåœ¨jsä»£ç é‡Œï¼Œæ»šåŠ¨æ¡æ˜¯è¢«æŠ½è±¡ä¸ºä¸€ä¸ªâ€œç‚¹â€æ¥å¯¹å¾…çš„ã€‚`scrollHeight`å…¶å®žä¸æ˜¯â€œæ»šåŠ¨æ¡çš„é«˜åº¦â€ï¼Œè€Œæ˜¯è¡¨ç¤ºæ»šåŠ¨æ¡éœ€è¦æ»šåŠ¨çš„é«˜åº¦ï¼Œå³å†…éƒ¨æ‰€æœ‰liçš„é«˜åº¦ã€‚è€Œ`scrollTop`è¡¨ç¤ºæ»šåŠ¨æ¡ï¼ˆä¸€ä¸ªç‚¹ï¼‰å½“å‰çš„ä½ç½®åœ¨ç´ æœ‰`li`é«˜åº¦é‡Œå äº†å¤šå°‘

*é¡¹ç›®å®žä¾‹*

```javascript
let dataListDOM = document.getElementById('listUlContainer');

//  èŽ·å–æ»šåŠ¨å†…å®¹çˆ¶çº§å…ƒç´ ï¼Œå³å®¹å™¨
DOMdataListDOM.addEventListener('scroll', () => {
	let clientHeight = document.documentElement.clientHeight || document.body.clientHeight;
	let scrollTop = dataListDOM.scrollTop;
	let scrollHeight = dataListDOM.scrollHeight;

	if ((clientHeight + scrollTop) >= scrollHeight) {
		setTimeout(() => {
			loadMoreData();
		}, 200);
	}
});
```

## äºŒã€IntersectionObserver

åœ¨`IntersectionObserver`å‡ºä¸–ä¹‹å‰ï¼Œè¦å®žçŽ°ä¸€ä¸ªæ‡’åŠ è½½ä¸€èˆ¬éƒ½éœ€è¦å¤§é‡è®¡ç®—scrollï¼Œè¿™ä¼šå¼•å‘æ€§èƒ½é—®é¢˜ï¼ŒäºŽæ˜¯åœ¨2016å¹´åˆï¼Œchrome51çŽ‡å…ˆæä¾›äº†ä¸€ä¸ªæ–°çš„APIï¼Œå³`IntersectionObserver`ï¼Œå®ƒå¯ä»¥ç”¨æ¥ç›‘å¬å…ƒç´ æ˜¯å¦è¿›å…¥äº†è®¾å¤‡çš„å¯è§†åŒºåŸŸä¹‹å†…ï¼Œè€Œä¸éœ€è¦é¢‘ç¹çš„è®¡ç®—æ¥åšè¿™ä¸ªåˆ¤æ–­ã€‚ä½†æ˜¯è¿™æ¯•ç«Ÿæ˜¯ä¸€ä¸ªæ–°å…´APIï¼Œæ‰€ä»¥å„ä¸ªæµè§ˆå™¨ å¯¹å…¶æ”¯æŒä¸å¤ªå‹å¥½ã€‚[ç‚¹æ­¤æŸ¥çœ‹å„ä¸ªæµè§ˆå™¨å¯¹intersectionObserverçš„æ”¯æŒæƒ…å†µ](https://caniuse.com/#search=IntersectionObserver)

æ­£å› ä¸ºæµè§ˆå™¨å¯¹è¯¥æ–¹æ³•æ”¯æŒä¸å¤ªå¥½ï¼Œæ‰€ä»¥è¦æƒ³è¯•ç”¨æ­¤æ–¹æ³•æœ€å¥½åŠ ä¸€ä¸ªåž«ç‰‡ï¼Œ[åœ°å€åœ¨æ­¤](https://github.com/w3c/IntersectionObserver/blob/master/polyfill/intersection-observer.js)

æœ‰ä¸€ç‚¹è¦è®°ä½ï¼š`IntersectionObserver` ä¸æ˜¯å®Œç¾Žç²¾ç¡®åˆ°åƒç´ çº§åˆ«ï¼Œä¹Ÿä¸æ˜¯ä½Žå»¶æ—¶æ€§çš„ï¼Œå®ƒæ˜¯å¼‚æ­¥çš„ã€‚ ä½¿ç”¨å®ƒå®žçŽ°ç±»ä¼¼ä¾èµ–æ»šåŠ¨æ•ˆæžœçš„åŠ¨ç”»æ³¨å®šä¼šå¤±è´¥ï¼Œå› ä¸ºå›žè°ƒå‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™é‚£äº›æ•°æ®â€”â€”ä¸¥æ ¼æ¥è¯´â€”â€”å·²ç»è¿‡æœŸäº†ã€‚

è°ƒç”¨ï¼š

```javascript
var observer = new IntersectionObserver(callback, options);
```

- `callback`: å½“è¢«ç›‘å¬å…ƒç´ çš„å¯è§æ€§å˜åŒ–æ—¶ï¼Œè§¦å‘çš„å›žè°ƒå‡½æ•°
- `options`: é…ç½®å‚æ•°ï¼Œå¯ä¼ å¯ä¸ä¼ ï¼Œæœ‰é»˜è®¤å±žæ€§å€¼

ä¸‹é¢å…ˆæ¥çœ‹ä¸€ä¸ªå®˜æ–¹ç¤ºä¾‹ä»£ç ï¼š

```javascript
//åˆå§‹åŒ–ä¸€ä¸ªå®žä¾‹
var observer = new IntersectionObserver(entries => {
    for (const entrie of entries) {
      console.log(entrie.target);
      
      // è¢«è§‚å¯Ÿçš„ç›®æ ‡å…ƒç´ ï¼Œæ˜¯ä¸€ä¸ª DOM èŠ‚ç‚¹å¯¹è±¡ 
      console.log(entrie.intersectionRatio);      // ç›®æ ‡å…ƒç´ çš„å¯è§æ¯”ä¾‹ï¼Œå®Œå…¨å¯è§æ—¶ä¸º1ï¼Œå®Œå…¨ä¸å¯è§æ—¶å°äºŽç­‰äºŽ0      
      console.log(entrie.time);                   // å½“å¯è§†çŠ¶æ€å˜åŒ–æ—¶ï¼ŒçŠ¶æ€å‘é€æ”¹å˜çš„æ—¶é—´æˆ³
      console.log(entrie.rootBounds);             // æ ¹å…ƒç´ çš„çŸ©å½¢åŒºåŸŸä¿¡æ¯ï¼Œå³ä¸ºgetBoundingClientRectæ–¹æ³•è¿”å›žçš„å€¼        
      console.log(entrie.boundingClientRect);     // ç›®æ ‡å…ƒç´ çš„çŸ©å½¢åŒºåŸŸçš„ä¿¡æ¯        
      console.log(entrie.intersectionRect);       // ç›®æ ‡å…ƒç´ ä¸Žè§†å£ï¼ˆæˆ–æ ¹å…ƒç´ ï¼‰çš„äº¤å‰åŒºåŸŸçš„ä¿¡æ¯
}}, {options});

// å¯¹å…ƒç´ targetæ·»åŠ ç›‘å¬ï¼Œå½“targetå…ƒç´ å˜åŒ–æ—¶ï¼Œå°±ä¼šè§¦å‘ä¸Šè¿°çš„å›žè°ƒ
observer.observe(target);

// ç§»é™¤ä¸€ä¸ªç›‘å¬ï¼Œç§»é™¤ä¹‹åŽï¼Œtargetå…ƒç´ çš„å¯è§†åŒºåŸŸå˜åŒ–ï¼Œå°†ä¸å†è§¦å‘å‰é¢çš„å›žè°ƒå‡½æ•°
observer.unobserve(target);

// åœæ­¢æ‰€æœ‰çš„ç›‘å¬
observer.disconnect();

options.root;       // æ‰€ç›‘å¬å¯¹è±¡çš„å…·ä½“ç¥–å…ˆå…ƒç´ (element)ã€‚å¦‚æžœæœªä¼ å…¥ä»»ä½•å€¼æˆ–å€¼ä¸ºnullï¼Œåˆ™é»˜è®¤ä½¿ç”¨viewportã€‚
options.rootMargin; // è®¡ç®—äº¤å‰æ—¶æ·»åŠ åˆ°æ ¹(root)è¾¹ç•Œç›’bounding boxçš„çŸ©å½¢åç§»é‡ï¼Œ å¯ä»¥æœ‰æ•ˆçš„ç¼©å°æˆ–æ‰©å¤§æ ¹çš„åˆ¤å®šèŒƒå›´ä»Žè€Œæ»¡è¶³è®¡ç®—éœ€è¦ã€‚é»˜è®¤å€¼ä¸º"0px 0px 0px 0px"ã€‚
options.thresholds  // ä¸€ä¸ªåŒ…å«é˜ˆå€¼çš„list, å‡åºæŽ’åˆ—, listä¸­çš„æ¯ä¸ªé˜ˆå€¼éƒ½æ˜¯ç›‘å¬å¯¹è±¡çš„äº¤å‰åŒºåŸŸä¸Žè¾¹ç•ŒåŒºåŸŸçš„æ¯”çŽ‡ã€‚å½“ç›‘å¬å¯¹è±¡çš„ä»»ä½•é˜ˆå€¼è¢«è¶Šè¿‡æ—¶ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªé€šçŸ¥(Notification)ã€‚å¦‚æžœæž„é€ å™¨æœªä¼ å…¥å€¼, åˆ™é»˜è®¤å€¼ä¸º0.
```

## ä¸‰ã€æ»šåŠ¨åŠ è½½ç¤ºä¾‹

å½“å®žçŽ°åˆ—è¡¨æ»šåŠ¨åŠ è½½æ—¶ï¼Œå¯åœ¨åˆ—è¡¨æœ€åŽæ‹¼æŽ¥ä¸€ä¸ªå…ƒç´ ï¼ˆå‡è®¾idä¸ºobserver-domï¼‰ï¼Œç„¶åŽç›‘å¬è¯¥å…ƒç´ ï¼Œå½“ç¦»å¼€é¡µé¢æˆ–è€…ä¸å†éœ€è¦æ»šåŠ¨åŠ è½½æ—¶å¯ç§»é™¤ç›‘å¬ã€‚

```javascript
var observe = new IntersectionObserver(function (entries) {
  if (entries[0].intersectionRatio > 0) {
    loadMoreData();
  }
}, {})

observe.observe(document.getElementById('observer-dom'));
```

<!-- more -->
