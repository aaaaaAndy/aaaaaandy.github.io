ğŸ·: #Event #å®ä»»åŠ¡ #å¾®ä»»åŠ¡ #EventLoop
***

## ä¸€ã€JavaScriptå•çº¿ç¨‹æœºåˆ¶

é¦–å…ˆæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ`JavaScript`æ˜¯ä¸€é—¨å•çº¿ç¨‹çš„è¯­è¨€ï¼Œæ‰€è°“å•çº¿ç¨‹æŒ‡çš„æ˜¯åœ¨`JavaScript`å¼•æ“ä¸­è´Ÿè´£è§£é‡Šå’Œæ‰§è¡Œä»£ç çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œé€šå¸¸ç§°ä¸ºä¸»çº¿ç¨‹ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆ`JavaScript`å¿…é¡»æ˜¯å•çº¿ç¨‹çš„è¯­è¨€ï¼Œè€Œä¸èƒ½åƒä»–çš„è€å¤§å“¥`Java`ä¸€æ ·ï¼Œæ‰‹åŠ¨å¼€å¯å¤šä¸ªçº¿ç¨‹å‘¢ï¼Ÿ

å› ä¸ºè¿™æ˜¯ç”±äº`JavaScript`æ‰€è¿è¡Œçš„æµè§ˆå™¨ç¯å¢ƒå†³å®šï¼Œä»–åªèƒ½æ˜¯å•çº¿ç¨‹çš„ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœ`JavaScript`èƒ½å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œé¡µé¢ä¸Šæœ‰ä¸€ä¸ª`div`ï¼Œæˆ‘ä»¬åŒæ—¶åœ¨å¤šä¸ªçº¿ç¨‹ä¸­æ¥æ”¹å˜è¿™ä¸ª`div`ä¸­çš„å†…å®¹ï¼Œé‚£ä¹ˆæœ€ç»ˆè¿™ä¸ª`div`ä¼šå˜æˆä»€ä¹ˆæ ·å­è°ä¹Ÿç¡®å®šä¸äº†ï¼Œæœ€ååªèƒ½å¬å¤©ç”±å‘½ï¼Œçœ‹å“ªä¸ªçº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªè¿è¡Œç»“æŸçš„ã€‚

å…¶å®`JavaScript`ä¹Ÿå¯ä»¥é€šè¿‡`Web Worker`å¼€å¯å¤šçº¿ç¨‹æ˜¯çš„ï¼Œä½†æ˜¯è¿™ä¸ªæ–°å¼€çº¿ç¨‹çš„åŠŸèƒ½è¢«é™åˆ¶äº†ï¼Œåªèƒ½åšä¸€äº›æ¶ˆè€—`CPU`çš„é€»è¾‘è¿ç®—ç­‰ï¼Œæ•°æ®ä¼ è¾“ä¹Ÿæ˜¯é€šè¿‡å›è°ƒçš„æ–¹å¼æ¥è¿›è¡Œï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„æ‰§è¡Œï¼›è€Œä¸”æœ€æœ€é‡è¦çš„æ˜¯ï¼Œ`Web Worker`ä¸èƒ½æ¥æ“ä½œ`dom`ï¼Œç¬”è€…ç»è¿‡å°è¯•å‘ç°ï¼Œåœ¨æ–°å¼€çš„çº¿ç¨‹ä¸­ç”šè‡³éƒ½ä¸èƒ½è·å–åˆ°`document`å’Œ`window`å¯¹è±¡ã€‚

## äºŒã€åŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡

å› ä¸º`JavaScript`æ˜¯å•çº¿ç¨‹è¿è¡Œçš„ï¼Œæ‰€æœ‰çš„ä»»åŠ¡åªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ’é˜Ÿæ‰§è¡Œï¼›ä½†æ˜¯å¦‚æœæŸä¸ªä»»åŠ¡ç‰¹åˆ«è€—æ—¶ï¼Œæ¯”å¦‚`Ajax`è¯·æ±‚ä¸€ä¸ªæ¥å£ï¼Œå¯èƒ½1sè¿”å›ç»“æœï¼Œä¹Ÿå¯èƒ½10sæ‰è¿”å›ï¼Œæœ‰å¾ˆå¤šçš„ä¸ç¡®å®šå› ç´ ï¼ˆç½‘ç»œå»¶è¿Ÿç­‰ï¼‰ï¼›å¦‚æœè¿™äº›ä»»åŠ¡ä¹Ÿæ”¾åˆ°ä¸»çº¿ç¨‹ä¸­å»ï¼Œé‚£ä¹ˆä¼šé˜»å¡æµè§ˆå™¨ï¼ˆç”¨æˆ·é™¤äº†ç­‰ï¼Œä¸èƒ½è¿›è¡Œå…¶ä»–æ“ä½œï¼‰ã€‚äºæ˜¯ï¼Œæµè§ˆå™¨å°±æŠŠè¿™äº›ä»»åŠ¡åˆ†æ´¾åˆ°å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ä¸­å»ã€‚

## ä¸‰ã€ä»€ä¹ˆæ˜¯äº‹ä»¶å¾ªç¯

äº‹ä»¶å¾ªç¯çš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

1. æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ªæ‰§è¡Œæ ˆã€‚
2. ä¸»çº¿ç¨‹å‘ç°æœ‰å¼‚æ­¥ä»»åŠ¡ï¼Œå°±åœ¨â€œä»»åŠ¡é˜Ÿåˆ—â€ä¹‹ä¸­åŠ å…¥ä¸€ä¸ªä»»åŠ¡äº‹ä»¶ã€‚
3. ä¸€æ—¦â€œæ‰§è¡Œæ ˆâ€ä¸­çš„æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç³»ç»Ÿå°±ä¼šè¯»å–â€œä»»åŠ¡é˜Ÿåˆ—â€ï¼ˆå…ˆè¿›å…ˆå‡ºåŸåˆ™ï¼‰ã€‚é‚£äº›å¯¹åº”çš„å¼‚æ­¥ä»»åŠ¡ï¼Œç»“æŸç­‰å¾…çŠ¶æ€ï¼Œè¿›å…¥æ‰§è¡Œæ ˆå¹¶å¼€å§‹æ‰§è¡Œã€‚
4. ä¸»çº¿ç¨‹ä¸æ–­é‡å¤ä¸Šé¢çš„ç¬¬ä¸‰æ­¥ï¼Œè¿™æ ·çš„ä¸€ä¸ªå¾ªç¯ç§°ä¸ºäº‹ä»¶å¾ªç¯ã€‚

## å››ã€å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡

å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œå“ªä¸ªä»»åŠ¡å‘¢ï¼Ÿäºæ˜¯åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­ï¼Œä¹Ÿè¿›è¡Œäº†ç­‰çº§åˆ’åˆ†ï¼Œåˆ†ä¸ºå®ä»»åŠ¡`ï¼ˆmacrotaskï¼‰`å’Œå¾®ä»»åŠ¡`ï¼ˆmicrotaskï¼‰`ï¼›ä¸åŒçš„APIæ³¨å†Œçš„ä»»åŠ¡ä¼šä¾æ¬¡è¿›å…¥è‡ªèº«å¯¹åº”çš„é˜Ÿåˆ—ä¸­ï¼Œç„¶åç­‰å¾…äº‹ä»¶å¾ªç¯å°†å®ƒä»¬ä¾æ¬¡å‹å…¥æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚

å®ä»»åŠ¡åŒ…æ‹¬ï¼š

-  *script(æ•´ä½“ä»£ç )*
-  setTimeout,
-  setInterval,
-  setImmediate,
- requestAnimationFrame
- postMessage
-  *I/O*
-  UI rendering

å¾®ä»»åŠ¡åŒ…æ‹¬ï¼š

- process.nextTick
- Promise
- Object.observe(å·²åºŸå¼ƒ)
- MutationObserver(html5æ–°ç‰¹æ€§)

æˆ‘ä»¬å¯ä»¥æŠŠæ•´ä½“çš„JSä»£ç ä¹Ÿçœ‹æˆæ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼Œä¸»çº¿ç¨‹ä¹Ÿæ˜¯ä»å®ä»»åŠ¡å¼€å§‹çš„ã€‚æˆ‘ä»¬æŠŠä¸Šé¢äº‹ä»¶å¾ªç¯çš„æ­¥éª¤æ›´æ–°ä¸€ä¸‹ï¼š

![](JavaScript/assets/6e80e5e0-7cb8-11eb-85f6-6fac77c0c9b3.png)

1. æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡
2. æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°å¾®ä»»åŠ¡å°±åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œé‡åˆ°å®ä»»åŠ¡å°±åŠ å…¥å®ä»»åŠ¡é˜Ÿåˆ—
3. å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œæ£€æŸ¥å½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰ï¼Œå°±ä¾æ¬¡æ‰§è¡Œï¼ˆä¸€è½®äº‹ä»¶å¾ªç¯ç»“æŸï¼‰
4. å¼€å§‹ä¸‹ä¸€ä¸ªå®ä»»åŠ¡

`process.nextTick` æ˜¯ä¸€ä¸ªç‹¬ç«‹äº `eventLoop` çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚
åœ¨æ¯ä¸€ä¸ª `eventLoop` é˜¶æ®µå®Œæˆåä¼šå»æ£€æŸ¥ `nextTick` é˜Ÿåˆ—ï¼Œå¦‚æœé‡Œé¢æœ‰ä»»åŠ¡ï¼Œä¼šè®©è¿™éƒ¨åˆ†ä»»åŠ¡ä¼˜å…ˆäºå¾®ä»»åŠ¡æ‰§è¡Œã€‚
æ˜¯æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡ä¸­æœ€å¿«æ‰§è¡Œçš„ã€‚

## äº”ã€asyncä¸await

`async` æ˜¯å¼‚æ­¥çš„æ„æ€ï¼Œ`await `åˆ™å¯ä»¥ç†è§£ä¸º `async wait`ã€‚æ‰€ä»¥å¯ä»¥ç†è§£` async `å°±æ˜¯ç”¨æ¥å£°æ˜ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œè€Œ `await `æ˜¯ç”¨æ¥ç­‰å¾…å¼‚æ­¥æ–¹æ³•æ‰§è¡Œ

### async

`async`å‡½æ•°è¿”å›ä¸€ä¸ª`promise`å¯¹è±¡ï¼Œä¸‹é¢ä¸¤ç§æ–¹æ³•æ˜¯ç­‰æ•ˆçš„

```javascript
function f() {
    return Promise.resolve('TEST');
}

// asyncF is equivalent to f!
async function asyncF() {
    return 'TEST';
}
```

### await

æ­£å¸¸æƒ…å†µä¸‹ï¼Œ`await`å‘½ä»¤åé¢æ˜¯ä¸€ä¸ª `Promise `å¯¹è±¡ï¼Œè¿”å›è¯¥å¯¹è±¡çš„ç»“æœã€‚å¦‚æœä¸æ˜¯ `Promise `å¯¹è±¡ï¼Œå°±ç›´æ¥è¿”å›å¯¹åº”çš„å€¼

```javascript
async function f(){
    // ç­‰åŒäº
    // return 123
    return await 123
}
f().then(v => console.log(v)) // 123
```

ä¸ç®¡`await`åé¢è·Ÿç€çš„æ˜¯ä»€ä¹ˆï¼Œ`await`éƒ½ä¼šé˜»å¡åé¢çš„ä»£ç 

```javascript
async function fn1 (){
    console.log(1)
    await fn2()
    console.log(2) // é˜»å¡
}

async function fn2 (){
    console.log('fn2')
}

fn1()
console.log(3)
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ`await` ä¼šé˜»å¡ä¸‹é¢çš„ä»£ç ï¼ˆå³åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼‰ï¼Œå…ˆæ‰§è¡Œ `async `å¤–é¢çš„åŒæ­¥ä»£ç ï¼ŒåŒæ­¥ä»£ç æ‰§è¡Œå®Œï¼Œå†å›åˆ° `async` å‡½æ•°ä¸­ï¼Œå†æ‰§è¡Œä¹‹å‰é˜»å¡çš„ä»£ç 

æ‰€ä»¥ä¸Šè¿°è¾“å‡ºç»“æœä¸ºï¼š`1`ï¼Œ`fn2`ï¼Œ`3`ï¼Œ`2`


## å…­ã€Nodeå’Œæµè§ˆå™¨äº‹ä»¶å¾ªç¯æœºåˆ¶æœ‰ä½•ä¸åŒ

### 1. çº¿ç¨‹ä¸è¿›ç¨‹

> **è¿›ç¨‹æ˜¯ CPUèµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼›çº¿ç¨‹æ˜¯ CPUè°ƒåº¦çš„æœ€å°å•ä½**

![](JavaScript/assets/20210129135856.png)


- è¿›ç¨‹å¥½æ¯”å›¾ä¸­çš„å·¥å‚ï¼Œæœ‰å•ç‹¬çš„ä¸“å±è‡ªå·±çš„å·¥å‚èµ„æºã€‚

- çº¿ç¨‹å¥½æ¯”å›¾ä¸­çš„å·¥äººï¼Œå¤šä¸ªå·¥äººåœ¨ä¸€ä¸ªå·¥å‚ä¸­åä½œå·¥ä½œï¼Œå·¥å‚ä¸å·¥äººæ˜¯ 1:nçš„å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´**ä¸€ä¸ªè¿›ç¨‹ç”±ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç»„æˆï¼Œçº¿ç¨‹æ˜¯ä¸€ä¸ªè¿›ç¨‹ä¸­ä»£ç çš„ä¸åŒæ‰§è¡Œè·¯çº¿**ï¼›

- å·¥å‚çš„ç©ºé—´æ˜¯å·¥äººä»¬å…±äº«çš„ï¼Œè¿™è±¡å¾**ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ç©ºé—´æ˜¯å…±äº«çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ç”¨è¿™äº›å…±äº«å†…å­˜**ã€‚

- å¤šä¸ªå·¥å‚ä¹‹é—´ç‹¬ç«‹å­˜åœ¨ã€‚

ä»¥Chromeæµè§ˆå™¨ä¸­ä¸ºä¾‹ï¼Œå½“ä½ æ‰“å¼€ä¸€ä¸ª Tab é¡µæ—¶ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ¯”å¦‚æ¸²æŸ“çº¿ç¨‹ã€JS å¼•æ“çº¿ç¨‹ã€HTTP è¯·æ±‚çº¿ç¨‹ç­‰ç­‰ã€‚å½“ä½ å‘èµ·ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå½“è¯·æ±‚ç»“æŸåï¼Œè¯¥çº¿ç¨‹å¯èƒ½å°±ä¼šè¢«é”€æ¯ã€‚

æµè§ˆå™¨å†…æ ¸æ˜¯å¤šçº¿ç¨‹ï¼Œåœ¨å†…æ ¸æ§åˆ¶ä¸‹å„çº¿ç¨‹ç›¸äº’é…åˆä»¥ä¿æŒåŒæ­¥ï¼Œä¸€ä¸ªæµè§ˆå™¨é€šå¸¸ç”±ä»¥ä¸‹å¸¸é©»çº¿ç¨‹ç»„æˆï¼š

- GUI æ¸²æŸ“çº¿ç¨‹
- JavaScriptå¼•æ“çº¿ç¨‹
- å®šæ—¶è§¦å‘å™¨çº¿ç¨‹
- äº‹ä»¶è§¦å‘çº¿ç¨‹
- å¼‚æ­¥httpè¯·æ±‚çº¿ç¨‹

### 2. æµè§ˆå™¨ä¸­çš„Event Loop

![|400](JavaScript/assets/20210129140631.png)

- ä¸€å¼€å§‹æ‰§è¡Œæ ˆç©º,æˆ‘ä»¬å¯ä»¥æŠŠ**æ‰§è¡Œæ ˆè®¤ä¸ºæ˜¯ä¸€ä¸ªå­˜å‚¨å‡½æ•°è°ƒç”¨çš„æ ˆç»“æ„ï¼Œéµå¾ªå…ˆè¿›åå‡ºçš„åŸåˆ™**ã€‚micro é˜Ÿåˆ—ç©ºï¼Œmacro é˜Ÿåˆ—é‡Œæœ‰ä¸”åªæœ‰ä¸€ä¸ª script è„šæœ¬ï¼ˆæ•´ä½“ä»£ç ï¼‰ã€‚

- å…¨å±€ä¸Šä¸‹æ–‡ï¼ˆscript æ ‡ç­¾ï¼‰è¢«æ¨å…¥æ‰§è¡Œæ ˆï¼ŒåŒæ­¥ä»£ç æ‰§è¡Œã€‚åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šåˆ¤æ–­æ˜¯åŒæ­¥ä»»åŠ¡è¿˜æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Œé€šè¿‡å¯¹ä¸€äº›æ¥å£çš„è°ƒç”¨ï¼Œå¯ä»¥äº§ç”Ÿæ–°çš„ macro-task ä¸ micro-taskï¼Œå®ƒä»¬ä¼šåˆ†åˆ«è¢«æ¨å…¥å„è‡ªçš„ä»»åŠ¡é˜Ÿåˆ—é‡Œã€‚åŒæ­¥ä»£ç æ‰§è¡Œå®Œäº†ï¼Œscript è„šæœ¬ä¼šè¢«ç§»å‡º macro é˜Ÿåˆ—ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ¬è´¨ä¸Šæ˜¯é˜Ÿåˆ—çš„ macro-task çš„æ‰§è¡Œå’Œå‡ºé˜Ÿçš„è¿‡ç¨‹ã€‚

- ä¸Šä¸€æ­¥æˆ‘ä»¬å‡ºé˜Ÿçš„æ˜¯ä¸€ä¸ª macro-taskï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬å¤„ç†çš„æ˜¯ micro-taskã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå½“ macro-task å‡ºé˜Ÿæ—¶ï¼Œä»»åŠ¡æ˜¯**ä¸€ä¸ªä¸€ä¸ª**æ‰§è¡Œçš„ï¼›è€Œ micro-task å‡ºé˜Ÿæ—¶ï¼Œä»»åŠ¡æ˜¯**ä¸€é˜Ÿä¸€é˜Ÿ**æ‰§è¡Œçš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¤„ç† micro é˜Ÿåˆ—è¿™ä¸€æ­¥ï¼Œä¼šé€ä¸ªæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å¹¶æŠŠå®ƒå‡ºé˜Ÿï¼Œç›´åˆ°é˜Ÿåˆ—è¢«æ¸…ç©ºã€‚

- **æ‰§è¡Œæ¸²æŸ“æ“ä½œï¼Œæ›´æ–°ç•Œé¢**

- æ£€æŸ¥æ˜¯å¦å­˜åœ¨ Web worker ä»»åŠ¡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å¯¹å…¶è¿›è¡Œå¤„ç†

- ä¸Šè¿°è¿‡ç¨‹å¾ªç¯å¾€å¤ï¼Œç›´åˆ°ä¸¤ä¸ªé˜Ÿåˆ—éƒ½æ¸…ç©º

### 3. Nodeä¸­çš„Event Loop

`Node` ä¸­çš„ `Event Loop` å’Œæµè§ˆå™¨ä¸­çš„æ˜¯å®Œå…¨ä¸ç›¸åŒçš„ä¸œè¥¿ã€‚Node.jsé‡‡ç”¨V8ä½œä¸ºjsçš„è§£æå¼•æ“ï¼Œè€ŒI/Oå¤„ç†æ–¹é¢ä½¿ç”¨äº†è‡ªå·±è®¾è®¡çš„`libuv`ï¼Œ`libuv`æ˜¯ä¸€ä¸ªåŸºäºäº‹ä»¶é©±åŠ¨çš„è·¨å¹³å°æŠ½è±¡å±‚ï¼Œå°è£…äº†ä¸åŒæ“ä½œç³»ç»Ÿä¸€äº›åº•å±‚ç‰¹æ€§ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€çš„APIï¼Œäº‹ä»¶å¾ªç¯æœºåˆ¶ä¹Ÿæ˜¯å®ƒé‡Œé¢çš„å®ç°ï¼ˆä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»ï¼‰

Node.jsçš„è¿è¡Œæœºåˆ¶å¦‚ä¸‹:

- V8å¼•æ“è§£æ`JavaScript`è„šæœ¬ã€‚
- è§£æåçš„ä»£ç ï¼Œè°ƒç”¨Node APIã€‚
- `libuv`åº“è´Ÿè´£Node APIçš„æ‰§è¡Œã€‚å®ƒå°†ä¸åŒçš„ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œå½¢æˆä¸€ä¸ªEvent Loopï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ï¼Œä»¥å¼‚æ­¥çš„æ–¹å¼å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ç»™V8å¼•æ“ã€‚
- V8å¼•æ“å†å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚

![](JavaScript/assets/20210129135644.png)

ä»ä¸Šå›¾ä¸­ï¼Œå¤§è‡´çœ‹å‡ºnodeä¸­çš„äº‹ä»¶å¾ªç¯çš„é¡ºåºï¼š

***å¤–éƒ¨è¾“å…¥æ•°æ®-->è½®è¯¢é˜¶æ®µ(poll)-->æ£€æŸ¥é˜¶æ®µ(check)-->å…³é—­äº‹ä»¶å›è°ƒé˜¶æ®µ(close callback)-->å®šæ—¶å™¨æ£€æµ‹é˜¶æ®µ(timer)-->I/Oäº‹ä»¶å›è°ƒé˜¶æ®µ(I/O callbacks)-->é—²ç½®é˜¶æ®µ(idle, prepare)-->è½®è¯¢é˜¶æ®µï¼ˆæŒ‰ç…§è¯¥é¡ºåºåå¤è¿è¡Œï¼‰...***

- timers é˜¶æ®µï¼šè¿™ä¸ªé˜¶æ®µæ‰§è¡Œtimerï¼ˆsetTimeoutã€setIntervalï¼‰çš„å›è°ƒ
- I/O callbacks é˜¶æ®µï¼šå¤„ç†ä¸€äº›ä¸Šä¸€è½®å¾ªç¯ä¸­çš„å°‘æ•°æœªæ‰§è¡Œçš„ I/O å›è°ƒ
- idle, prepare é˜¶æ®µï¼šä»…nodeå†…éƒ¨ä½¿ç”¨
- poll é˜¶æ®µï¼šè·å–æ–°çš„I/Oäº‹ä»¶, é€‚å½“çš„æ¡ä»¶ä¸‹nodeå°†é˜»å¡åœ¨è¿™é‡Œ
- check é˜¶æ®µï¼šæ‰§è¡Œ setImmediate() çš„å›è°ƒ
- close callbacks é˜¶æ®µï¼šæ‰§è¡Œ socket çš„ close äº‹ä»¶å›è°ƒ

### 4. Nodeä¸æµè§ˆå™¨çš„ Event Loop å·®å¼‚

æµè§ˆå™¨ç¯å¢ƒä¸‹ï¼Œmicrotaskçš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯æ¯ä¸ªmacrotaskæ‰§è¡Œå®Œä¹‹åæ‰§è¡Œã€‚è€Œåœ¨Node.jsä¸­ï¼Œmicrotaskä¼šåœ¨äº‹ä»¶å¾ªç¯çš„å„ä¸ªé˜¶æ®µä¹‹é—´æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œå®Œæ¯•ï¼Œå°±ä¼šå»æ‰§è¡Œmicrotaské˜Ÿåˆ—çš„ä»»åŠ¡ã€‚

## ä¸ƒã€æµç¨‹åˆ†æ

é€šè¿‡å¯¹ä¸Šé¢çš„äº†è§£ï¼Œæˆ‘ä»¬å¯¹`JavaScript`å¯¹å„ç§åœºæ™¯çš„æ‰§è¡Œé¡ºåºæœ‰äº†å¤§è‡´çš„äº†è§£

è¿™é‡Œç›´æ¥ä¸Šä»£ç ï¼š

```javascript
async function async1() {
    console.log('async1 start')
    await async2()
    console.log('async1 end')
}
async function async2() {
    console.log('async2')
}
console.log('script start')
setTimeout(function () {
    console.log('settimeout')
})
async1()
new Promise(function (resolve) {
    console.log('promise1')
    resolve()
}).then(function () {
    console.log('promise2')
})
console.log('script end')
```

åˆ†æè¿‡ç¨‹ï¼š

1. æ‰§è¡Œæ•´æ®µä»£ç ï¼Œé‡åˆ° `console.log('script start')` ç›´æ¥æ‰“å°ç»“æœï¼Œè¾“å‡º `script start`
2. é‡åˆ°å®šæ—¶å™¨äº†ï¼Œå®ƒæ˜¯å®ä»»åŠ¡ï¼Œå…ˆæ”¾ç€ä¸æ‰§è¡Œ
3. é‡åˆ° `async1()`ï¼Œæ‰§è¡Œ `async1` å‡½æ•°ï¼Œå…ˆæ‰“å° `async1 start`ï¼Œä¸‹é¢é‡åˆ°` await `æ€ä¹ˆåŠï¼Ÿå…ˆæ‰§è¡Œ `async2`ï¼Œæ‰“å° `async2`ï¼Œç„¶åé˜»å¡ä¸‹é¢ä»£ç ï¼ˆå³åŠ å…¥å¾®ä»»åŠ¡åˆ—è¡¨ï¼‰ï¼Œè·³å‡ºå»æ‰§è¡ŒåŒæ­¥ä»£ç 
4. è·³åˆ° `new Promise` è¿™é‡Œï¼Œç›´æ¥æ‰§è¡Œï¼Œæ‰“å° `promise1`ï¼Œä¸‹é¢é‡åˆ° `.then()`ï¼Œå®ƒæ˜¯å¾®ä»»åŠ¡ï¼Œæ”¾åˆ°å¾®ä»»åŠ¡åˆ—è¡¨ç­‰å¾…æ‰§è¡Œ
5. æœ€åä¸€è¡Œç›´æ¥æ‰“å° `script end`ï¼Œç°åœ¨åŒæ­¥ä»£ç æ‰§è¡Œå®Œäº†ï¼Œå¼€å§‹æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œå³ `await `ä¸‹é¢çš„ä»£ç ï¼Œæ‰“å° `async1 end`
6. ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œå³æ‰§è¡Œ `then` çš„å›è°ƒï¼Œæ‰“å° `promise2`
7. ä¸Šä¸€ä¸ªå®ä»»åŠ¡æ‰€æœ‰äº‹éƒ½åšå®Œäº†ï¼Œå¼€å§‹ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼Œå°±æ˜¯å®šæ—¶å™¨ï¼Œæ‰“å° `settimeout`

æ‰€ä»¥æœ€åçš„ç»“æœæ˜¯ï¼š`script start`ã€`async1 start`ã€`async2`ã€`promise1`ã€`script end`ã€`async1 end`ã€`promise2`ã€`settimeout`
