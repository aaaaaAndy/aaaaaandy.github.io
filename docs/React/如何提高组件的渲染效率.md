ğŸ·: #react #shouldComponentUpdate #PureComponent #memo
***
## ä¸€ã€æ˜¯ä»€ä¹ˆ
`react` åŸºäºè™šæ‹Ÿ `DOM` å’Œé«˜æ•ˆ `Diff `ç®—æ³•çš„å®Œç¾é…åˆï¼Œå®ç°äº†å¯¹ `DOM`æœ€å°ç²’åº¦çš„æ›´æ–°ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ`React `å¯¹ `DOM `çš„æ¸²æŸ“æ•ˆç‡è¶³ä»¥æˆ‘ä»¬çš„ä¸šåŠ¡æ—¥å¸¸
å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæ€§èƒ½é—®é¢˜ä¾ç„¶ä¼šå›°æ‰°æˆ‘ä»¬ã€‚æ­¤æ—¶éœ€è¦é‡‡å–ä¸€äº›æªæ–½æ¥æå‡è¿è¡Œæ€§èƒ½ï¼Œé¿å…ä¸å¿…è¦çš„æ¸²æŸ“åˆ™æ˜¯ä¸šåŠ¡ä¸­å¸¸è§çš„ä¼˜åŒ–æ‰‹æ®µä¹‹ä¸€
## äºŒã€å¦‚ä½•åš
åœ¨ä¹‹å‰æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°`render`çš„è§¦å‘æ—¶æœºï¼Œç®€å•æ¥è®²å°±æ˜¯ç±»ç»„ä»¶é€šè¿‡è°ƒç”¨`setState`æ–¹æ³•ï¼Œ å°±ä¼šå¯¼è‡´`render`ï¼Œçˆ¶ç»„ä»¶ä¸€æ—¦å‘ç”Ÿ`render`æ¸²æŸ“ï¼Œå­ç»„ä»¶ä¸€å®šä¹Ÿä¼šæ‰§è¡Œ`render`æ¸²æŸ“
ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œçˆ¶ç»„ä»¶æ¸²æŸ“å¯¼è‡´å­ç»„ä»¶æ¸²æŸ“ï¼Œå­ç»„ä»¶å¹¶æ²¡æœ‰å‘ç”Ÿä»»ä½•æ”¹å˜ï¼Œè¿™æ—¶å€™å°±å¯ä»¥ä»é¿å…æ— è°“çš„æ¸²æŸ“ï¼Œå…·ä½“å®ç°çš„æ–¹å¼æœ‰å¦‚ä¸‹ï¼š
- shouldComponentUpdate
- PureComponent
- React.memo
### shouldComponentUpdate
é€šè¿‡`shouldComponentUpdate`ç”Ÿå‘½å‘¨æœŸå‡½æ•°æ¥æ¯”å¯¹ `state `å’Œ `props`ï¼Œç¡®å®šæ˜¯å¦è¦é‡æ–°æ¸²æŸ“
é»˜è®¤æƒ…å†µä¸‹è¿”å›`true`è¡¨ç¤ºé‡æ–°æ¸²æŸ“ï¼Œå¦‚æœä¸å¸Œæœ›ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œè¿”å› `false` å³å¯
### PureComponent
è·Ÿ`shouldComponentUpdate `åŸç†åŸºæœ¬ä¸€è‡´ï¼Œé€šè¿‡å¯¹ `props` å’Œ `state`çš„æµ…æ¯”è¾ƒç»“æœæ¥å®ç° `shouldComponentUpdate`ï¼Œæºç å¤§è‡´å¦‚ä¸‹ï¼š
```javascript
if (this._compositeType === CompositeTypes.PureClass) {
    shouldUpdate = !shallowEqual(prevProps, nextProps) || ! shallowEqual(inst.state, nextState);
}
```
`shallowEqual`å¯¹åº”æ–¹æ³•å¤§è‡´å¦‚ä¸‹ï¼š
```javascript
const hasOwnProperty = Object.prototype.hasOwnProperty;

/**
 * is æ–¹æ³•æ¥åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦æ˜¯ç›¸ç­‰çš„å€¼ï¼Œä¸ºä½•è¿™ä¹ˆå†™å¯ä»¥ç§»æ­¥ MDN çš„æ–‡æ¡£
 * https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is
 */
function is(x: mixed, y: mixed): boolean {
  if (x === y) {
    return x !== 0 || y !== 0 || 1 / x === 1 / y;
  } else {
    return x !== x && y !== y;
  }
}

function shallowEqual(objA: mixed, objB: mixed): boolean {
  // é¦–å…ˆå¯¹åŸºæœ¬ç±»å‹è¿›è¡Œæ¯”è¾ƒ
  if (is(objA, objB)) {
    return true;
  }

  if (typeof objA !== 'object' || objA === null ||
      typeof objB !== 'object' || objB === null) {
    return false;
  }

  const keysA = Object.keys(objA);
  const keysB = Object.keys(objB);

  // é•¿åº¦ä¸ç›¸ç­‰ç›´æ¥è¿”å›false
  if (keysA.length !== keysB.length) {
    return false;
  }

  // keyç›¸ç­‰çš„æƒ…å†µä¸‹ï¼Œå†å»å¾ªç¯æ¯”è¾ƒ
  for (let i = 0; i < keysA.length; i++) {
    if (
      !hasOwnProperty.call(objB, keysA[i]) ||
      !is(objA[keysA[i]], objB[keysA[i]])
    ) {
      return false;
    }
  }

  return true;
}
```
å½“å¯¹è±¡åŒ…å«å¤æ‚çš„æ•°æ®ç»“æ„æ—¶ï¼Œå¯¹è±¡æ·±å±‚çš„æ•°æ®å·²æ”¹å˜å´æ²¡æœ‰è§¦å‘ `render`
æ³¨æ„ï¼šåœ¨`react`ä¸­ï¼Œæ˜¯ä¸å»ºè®®ä½¿ç”¨æ·±å±‚æ¬¡ç»“æ„çš„æ•°æ®
### React.memo
`React.memo`ç”¨æ¥ç¼“å­˜ç»„ä»¶çš„æ¸²æŸ“ï¼Œé¿å…ä¸å¿…è¦çš„æ›´æ–°ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œä¸ `PureComponent` ååˆ†ç±»ä¼¼ã€‚ä½†ä¸åŒçš„æ˜¯ï¼Œ `React.memo` åªèƒ½ç”¨äºå‡½æ•°ç»„ä»¶
```jsx
import { memo } from 'react';

function Button(props) {
  // Component code
}

export default memo(Button);
```
å¦‚æœéœ€è¦æ·±å±‚æ¬¡æ¯”è¾ƒï¼Œè¿™æ—¶å€™å¯ä»¥ç»™`memo`ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’æ¯”è¾ƒå‡½æ•°
```jsx
function arePropsEqual(prevProps, nextProps) {
  // your code
  return prevProps === nextProps;
}

export default memo(Button, arePropsEqual);
```
## ä¸‰ã€æ€»ç»“
åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå‰ç«¯æ€§èƒ½é—®é¢˜æ˜¯ä¸€ä¸ªå¿…é¡»è€ƒè™‘çš„é—®é¢˜ï¼Œéšç€ä¸šåŠ¡çš„å¤æ‚ï¼Œé‡åˆ°æ€§èƒ½é—®é¢˜çš„æ¦‚ç‡ä¹Ÿåœ¨å¢é«˜
é™¤æ­¤ä¹‹å¤–ï¼Œå»ºè®®å°†é¡µé¢è¿›è¡Œæ›´å°çš„é¢—ç²’åŒ–ï¼Œå¦‚æœä¸€ä¸ªè¿‡å¤§ï¼Œå½“çŠ¶æ€å‘ç”Ÿä¿®æ”¹çš„æ—¶å€™ï¼Œå°±ä¼šå¯¼è‡´æ•´ä¸ªå¤§ç»„ä»¶çš„æ¸²æŸ“ï¼Œè€Œå¯¹ç»„ä»¶è¿›è¡Œæ‹†åˆ†åï¼Œç²’åº¦å˜å°äº†ï¼Œä¹Ÿèƒ½å¤Ÿå‡å°‘å­ç»„ä»¶ä¸å¿…è¦çš„æ¸²æŸ“
## å‚è€ƒæ–‡çŒ®
- https://juejin.cn/post/6844903781679759367#heading-12
