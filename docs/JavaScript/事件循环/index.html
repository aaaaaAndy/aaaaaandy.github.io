<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-JavaScript/事件循环">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">事件循环 | aaaaaandy.github.io</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aaaaaAndy.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aaaaaAndy.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aaaaaAndy.github.io/docs/JavaScript/事件循环"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="事件循环 | aaaaaandy.github.io"><meta data-rh="true" name="description" content="一、JavaScript 单线程机制"><meta data-rh="true" property="og:description" content="一、JavaScript 单线程机制"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aaaaaAndy.github.io/docs/JavaScript/事件循环"><link data-rh="true" rel="alternate" href="https://aaaaaAndy.github.io/docs/JavaScript/事件循环" hreflang="en"><link data-rh="true" rel="alternate" href="https://aaaaaAndy.github.io/docs/JavaScript/事件循环" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="aaaaaandy.github.io RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="aaaaaandy.github.io Atom Feed"><link rel="stylesheet" href="/assets/css/styles.008d67db.css">
<link rel="preload" href="/assets/js/runtime~main.ffc5e5a1.js" as="script">
<link rel="preload" href="/assets/js/main.8fee9b7a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="aaaaaAndy" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="aaaaaAndy" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">aaaaaAndy</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/JavaScript/JavaScript高级程序设计/">JavaScript高级程序设计</a><button aria-label="Toggle the collapsible sidebar category &#x27;JavaScript高级程序设计&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/JavaScript/编写可维护的JavaScript/">编写可维护的JavaScript</a><button aria-label="Toggle the collapsible sidebar category &#x27;编写可维护的JavaScript&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/">readme</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript怎么进行类型转换">JavaScript怎么进行类型转换</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript数据类型及其区别">JavaScript数据类型及其区别</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/typeof null为什么等于object">typeof null为什么等于object</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/几种判断数据类型的方法">几种判断数据类型的方法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript数据结构">JavaScript数据结构</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/String字符串常用方法">String字符串常用方法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/BOM常用操作">BOM常用操作</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/DOM事件模型">DOM事件模型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/DOM常用操作">DOM常用操作</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/EventEmitter">EventEmitter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/IntersectionObserver-无限滚动">IntersectionObserver-无限滚动</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript中如何实现函数缓存">JavaScript中如何实现函数缓存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript事件冒泡与捕获">JavaScript事件冒泡与捕获</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript内存泄漏">JavaScript内存泄漏</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript原型与原型链">JavaScript原型与原型链</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript各种宽高属性">JavaScript各种宽高属性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript实现滚动加载更多">JavaScript实现滚动加载更多</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript执行上下文">JavaScript执行上下文</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript本地缓存方式">JavaScript本地缓存方式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript精度丢失">JavaScript精度丢失</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/JavaScript闭包">JavaScript闭包</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/Javascript如何实现继承">Javascript如何实现继承</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/Jsbridge">Jsbridge</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/Websocket总结">Websocket总结</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/ajax原理及实现">ajax原理及实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/for循环中的setTimeout">for循环中的setTimeout</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/new操作符">new操作符</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/requirejs使用方法">requirejs使用方法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/this对象">this对象</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/web常见的攻击方式有哪些">web常见的攻击方式有哪些</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/不同设备的click">不同设备的click</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/事件代理及其应用场景">事件代理及其应用场景</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/JavaScript/事件循环">事件循环</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/什么是单点登录">什么是单点登录</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/作用域链">作用域链</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/偏函数与函数柯里化">偏函数与函数柯里化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/函数function">函数function</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/函数式编程">函数式编程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/函数防抖和节流">函数防抖和节流</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/动态引入（require-import）">动态引入（require-import）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/大文件上传如何做断点续传">大文件上传如何做断点续传</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/如何中断循环">如何中断循环</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/如何判断一个元素是否在可视区域中">如何判断一个元素是否在可视区域中</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/如何实现上拉加载，下拉刷新">如何实现上拉加载，下拉刷新</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/如何正确判断相等性">如何正确判断相等性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/尾递归">尾递归</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/正则表达式">正则表达式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/浅谈call,apply和bind">浅谈call,apply和bind</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/深拷贝和浅拷贝">深拷贝和浅拷贝</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/JavaScript/移动端click事件300ms延迟">移动端click事件300ms延迟</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">事件循环</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>事件循环</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一javascript-单线程机制">一、JavaScript 单线程机制<a href="#一javascript-单线程机制" class="hash-link" aria-label="Direct link to 一、JavaScript 单线程机制" title="Direct link to 一、JavaScript 单线程机制">​</a></h2><p>首先我们都知道，<code>JavaScript</code>是一门单线程的语言，所谓单线程指的是在<code>JavaScript</code>引擎中负责解释和执行代码的线程只有一个，通常称为主线程。那么为什么<code>JavaScript</code>必须是单线程的语言，而不能像他的老大哥<code>Java</code>一样，手动开启多个线程呢？</p><p>因为这是由于<code>JavaScript</code>所运行的浏览器环境决定，他只能是单线程的。试想一下，如果<code>JavaScript</code>能开启多个线程，页面上有一个<code>div</code>，我们同时在多个线程中来改变这个<code>div</code>中的内容，那么最终这个<code>div</code>会变成什么样子谁也确定不了，最后只能听天由命，看哪个线程是最后一个运行结束的。</p><p>其实<code>JavaScript</code>也可以通过<code>Web Worker</code>开启多线程是的，但是这个新开线程的功能被限制了，只能做一些消耗<code>CPU</code>的逻辑运算等，数据传输也是通过回调的方式来进行，不会阻塞主线程的执行；而且最最重要的是，<code>Web Worker</code>不能来操作<code>dom</code>，笔者经过尝试发现，在新开的线程中甚至都不能获取到<code>document</code>和<code>window</code>对象。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二同步任务和异步任务">二、同步任务和异步任务<a href="#二同步任务和异步任务" class="hash-link" aria-label="Direct link to 二、同步任务和异步任务" title="Direct link to 二、同步任务和异步任务">​</a></h2><p>因为<code>JavaScript</code>是单线程运行的，所有的任务只能在主线程上排队执行；但是如果某个任务特别耗时，比如<code>Ajax</code>请求一个接口，可能 1s 返回结果，也可能 10s 才返回，有很多的不确定因素（网络延迟等）；如果这些任务也放到主线程中去，那么会阻塞浏览器（用户除了等，不能进行其他操作）。于是，浏览器就把这些任务分派到异步任务队列中去。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三什么是事件循环">三、什么是事件循环<a href="#三什么是事件循环" class="hash-link" aria-label="Direct link to 三、什么是事件循环" title="Direct link to 三、什么是事件循环">​</a></h2><p>事件循环的流程大致如下：</p><ol><li>所有任务都在主线程上执行，形成一个执行栈。</li><li>主线程发现有异步任务，就在“任务队列”之中加入一个任务事件。</li><li>一旦“执行栈”中的所有同步任务执行完毕，系统就会读取“任务队列”（先进先出原则）。那些对应的异步任务，结束等待状态，进入执行栈并开始执行。</li><li>主线程不断重复上面的第三步，这样的一个循环称为事件循环。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四宏任务与微任务">四、宏任务与微任务<a href="#四宏任务与微任务" class="hash-link" aria-label="Direct link to 四、宏任务与微任务" title="Direct link to 四、宏任务与微任务">​</a></h2><p>如果任务队列中有多个异步任务，那么先执行哪个任务呢？于是在异步任务中，也进行了等级划分，分为宏任务<code>（macrotask）</code>和微任务<code>（microtask）</code>；不同的 API 注册的任务会依次进入自身对应的队列中，然后等待事件循环将它们依次压入执行栈中执行。</p><p>宏任务包括：</p><ul><li><em>script(整体代码)</em></li><li>setTimeout,</li><li>setInterval,</li><li>setImmediate,</li><li>requestAnimationFrame</li><li>postMessage</li><li><em>I/O</em></li><li>UI rendering</li></ul><p>微任务包括：</p><ul><li>process.nextTick</li><li>Promise</li><li>Object.observe(已废弃)</li><li>MutationObserver(html5 新特性)</li></ul><p>我们可以把整体的 JS 代码也看成是一个宏任务，主线程也是从宏任务开始的。我们把上面事件循环的步骤更新一下：</p><p><img loading="lazy" src="/assets/images/6e80e5e0-7cb8-11eb-85f6-6fac77c0c9b3-0ad18eb19aaea5468416a90b592c80ab.png" width="910" height="859" class="img_ev3q"></p><ol><li>执行一个宏任务</li><li>执行过程中如果遇到微任务就加入微任务队列，遇到宏任务就加入宏任务队列</li><li>宏任务执行完毕后，检查当前微任务队列，如果有，就依次执行（一轮事件循环结束）</li><li>开始下一个宏任务</li></ol><p><code>process.nextTick</code> 是一个独立于 <code>eventLoop</code> 的任务队列。在每一个 <code>eventLoop</code> 阶段完成后会去检查 <code>nextTick</code> 队列，如果里面有任务，会让这部分任务优先于微任务执行。是所有异步任务中最快执行的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五async-与-await">五、async 与 await<a href="#五async-与-await" class="hash-link" aria-label="Direct link to 五、async 与 await" title="Direct link to 五、async 与 await">​</a></h2><p><code>async</code> 是异步的意思，<code>await </code>则可以理解为 <code>async wait</code>。所以可以理解<code>async</code>就是用来声明一个异步方法，而 <code>await </code>是用来等待异步方法执行</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="async">async<a href="#async" class="hash-link" aria-label="Direct link to async" title="Direct link to async">​</a></h3><p><code>async</code>函数返回一个<code>promise</code>对象，下面两种方法是等效的</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Promise</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">resolve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;TEST&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// asyncF is equivalent to f!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">asyncF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;TEST&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="await">await<a href="#await" class="hash-link" aria-label="Direct link to await" title="Direct link to await">​</a></h3><p>正常情况下，<code>await</code>命令后面是一个 <code>Promise </code>对象，返回该对象的结果。如果不是 <code>Promise </code>对象，就直接返回对应的值</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 等同于</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// return 123</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 123</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>不管<code>await</code>后面跟着的是什么，<code>await</code>都会阻塞后面的代码</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fn1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fn2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 阻塞</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fn2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;fn2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">fn1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的例子中，<code>await</code> 会阻塞下面的代码（即加入微任务队列），先执行 <code>async </code>外面的同步代码，同步代码执行完，再回到 <code>async</code> 函数中，再执行之前阻塞的代码</p><p>所以上述输出结果为：<code>1</code>，<code>fn2</code>，<code>3</code>，<code>2</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="六node-和浏览器事件循环机制有何不同">六、Node 和浏览器事件循环机制有何不同<a href="#六node-和浏览器事件循环机制有何不同" class="hash-link" aria-label="Direct link to 六、Node 和浏览器事件循环机制有何不同" title="Direct link to 六、Node 和浏览器事件循环机制有何不同">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-线程与进程">1. 线程与进程<a href="#1-线程与进程" class="hash-link" aria-label="Direct link to 1. 线程与进程" title="Direct link to 1. 线程与进程">​</a></h3><blockquote><p><strong>进程是 CPU 资源分配的最小单位；线程是 CPU 调度的最小单位</strong></p></blockquote><p><img loading="lazy" src="/assets/images/20210129135856-f9dbda901c0580f1980f4131f5249260.png" width="443" height="162" class="img_ev3q"></p><ul><li><p>进程好比图中的工厂，有单独的专属自己的工厂资源。</p></li><li><p>线程好比图中的工人，多个工人在一个工厂中协作工作，工厂与工人是 1:n 的关系。也就是说<strong>一个进程由一个或多个线程组成，线程是一个进程中代码的不同执行路线</strong>；</p></li><li><p>工厂的空间是工人们共享的，这象征<strong>一个进程的内存空间是共享的，每个线程都可用这些共享内存</strong>。</p></li><li><p>多个工厂之间独立存在。</p></li></ul><p>以 Chrome 浏览器中为例，当你打开一个 Tab 页时，其实就是创建了一个进程，一个进程中可以有多个线程，比如渲染线程、JS 引擎线程、HTTP 请求线程等等。当你发起一个请求时，其实就是创建了一个线程，当请求结束后，该线程可能就会被销毁。</p><p>浏览器内核是多线程，在内核控制下各线程相互配合以保持同步，一个浏览器通常由以下常驻线程组成：</p><ul><li>GUI 渲染线程</li><li>JavaScript 引擎线程</li><li>定时触发器线程</li><li>事件触发线程</li><li>异步 http 请求线程</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-浏览器中的-event-loop">2. 浏览器中的 Event Loop<a href="#2-浏览器中的-event-loop" class="hash-link" aria-label="Direct link to 2. 浏览器中的 Event Loop" title="Direct link to 2. 浏览器中的 Event Loop">​</a></h3><p><img loading="lazy" alt="|400" src="/assets/images/20210129140631-8ae0a5f1070d051a002f3edbcc4f5627.png" width="786" height="902" class="img_ev3q"></p><ul><li><p>一开始执行栈空,我们可以把<strong>执行栈认为是一个存储函数调用的栈结构，遵循先进后出的原则</strong>。micro 队列空，macro 队列里有且只有一个 script 脚本（整体代码）。</p></li><li><p>全局上下文（script 标签）被推入执行栈，同步代码执行。在执行的过程中，会判断是同步任务还是异步任务，通过对一些接口的调用，可以产生新的 macro-task 与 micro-task，它们会分别被推入各自的任务队列里。同步代码执行完了，script 脚本会被移出 macro 队列，这个过程本质上是队列的 macro-task 的执行和出队的过程。</p></li><li><p>上一步我们出队的是一个 macro-task，这一步我们处理的是 micro-task。但需要注意的是：当 macro-task 出队时，任务是<strong>一个一个</strong>执行的；而 micro-task 出队时，任务是<strong>一队一队</strong>执行的。因此，我们处理 micro 队列这一步，会逐个执行队列中的任务并把它出队，直到队列被清空。</p></li><li><p><strong>执行渲染操作，更新界面</strong></p></li><li><p>检查是否存在 Web worker 任务，如果有，则对其进行处理</p></li><li><p>上述过程循环往复，直到两个队列都清空</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-node-中的-event-loop">3. Node 中的 Event Loop<a href="#3-node-中的-event-loop" class="hash-link" aria-label="Direct link to 3. Node 中的 Event Loop" title="Direct link to 3. Node 中的 Event Loop">​</a></h3><p><code>Node</code> 中的 <code>Event Loop</code> 和浏览器中的是完全不相同的东西。Node.js 采用 V8 作为 js 的解析引擎，而 I/O 处理方面使用了自己设计的<code>libuv</code>，<code>libuv</code>是一个基于事件驱动的跨平台抽象层，封装了不同操作系统一些底层特性，对外提供统一的 API，事件循环机制也是它里面的实现（下文会详细介绍）</p><p>Node.js 的运行机制如下:</p><ul><li>V8 引擎解析<code>JavaScript</code>脚本。</li><li>解析后的代码，调用 Node API。</li><li><code>libuv</code>库负责 Node API 的执行。它将不同的任务分配给不同的线程，形成一个 Event Loop（事件循环），以异步的方式将任务的执行结果返回给 V8 引擎。</li><li>V8 引擎再将结果返回给用户。</li></ul><p><img loading="lazy" src="data:image/png;base64,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" width="359" height="331" class="img_ev3q"></p><p>从上图中，大致看出 node 中的事件循环的顺序：</p><p><strong><em>外部输入数据--&gt;轮询阶段(poll)--&gt;检查阶段(check)--&gt;关闭事件回调阶段(close callback)--&gt;定时器检测阶段(timer)--&gt;I/O 事件回调阶段(I/O callbacks)--&gt;闲置阶段(idle, prepare)--&gt;轮询阶段（按照该顺序反复运行）...</em></strong></p><ul><li>timers 阶段：这个阶段执行 timer（setTimeout、setInterval）的回调</li><li>I/O callbacks 阶段：处理一些上一轮循环中的少数未执行的 I/O 回调</li><li>idle, prepare 阶段：仅 node 内部使用</li><li>poll 阶段：获取新的 I/O 事件, 适当的条件下 node 将阻塞在这里</li><li>check 阶段：执行 setImmediate() 的回调</li><li>close callbacks 阶段：执行 socket 的 close 事件回调</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-node-与浏览器的-event-loop-差异">4. Node 与浏览器的 Event Loop 差异<a href="#4-node-与浏览器的-event-loop-差异" class="hash-link" aria-label="Direct link to 4. Node 与浏览器的 Event Loop 差异" title="Direct link to 4. Node 与浏览器的 Event Loop 差异">​</a></h3><p>浏览器环境下，microtask 的任务队列是每个 macrotask 执行完之后执行。而在 Node.js 中，microtask 会在事件循环的各个阶段之间执行，也就是一个阶段执行完毕，就会去执行 microtask 队列的任务。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="七流程分析">七、流程分析<a href="#七流程分析" class="hash-link" aria-label="Direct link to 七、流程分析" title="Direct link to 七、流程分析">​</a></h2><p>通过对上面的了解，我们对<code>JavaScript</code>对各种场景的执行顺序有了大致的了解</p><p>这里直接上代码：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">async1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;async1 start&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">async2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;async1 end&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">async2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;async2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;script start&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;settimeout&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">async1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">resolve</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;promise1&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">resolve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;promise2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;script end&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>分析过程：</p><ol><li>执行整段代码，遇到 <code>console.log(&#x27;script start&#x27;)</code> 直接打印结果，输出 <code>script start</code></li><li>遇到定时器了，它是宏任务，先放着不执行</li><li>遇到 <code>async1()</code>，执行 <code>async1</code> 函数，先打印 <code>async1 start</code>，下面遇到<code>await</code>怎么办？先执行 <code>async2</code>，打印 <code>async2</code>，然后阻塞下面代码（即加入微任务列表），跳出去执行同步代码</li><li>跳到 <code>new Promise</code> 这里，直接执行，打印 <code>promise1</code>，下面遇到 <code>.then()</code>，它是微任务，放到微任务列表等待执行</li><li>最后一行直接打印 <code>script end</code>，现在同步代码执行完了，开始执行微任务，即 <code>await </code>下面的代码，打印 <code>async1 end</code></li><li>继续执行下一个微任务，即执行 <code>then</code> 的回调，打印 <code>promise2</code></li><li>上一个宏任务所有事都做完了，开始下一个宏任务，就是定时器，打印 <code>settimeout</code></li></ol><p>所以最后的结果是：<code>script start</code>、<code>async1 start</code>、<code>async2</code>、<code>promise1</code>、<code>script end</code>、<code>async1 end</code>、<code>promise2</code>、<code>settimeout</code></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/event">Event</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/宏任务">宏任务</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/微任务">微任务</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/event-loop">EventLoop</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/JavaScript/事件代理及其应用场景"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">事件代理及其应用场景</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/JavaScript/什么是单点登录"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">什么是单点登录</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一javascript-单线程机制" class="table-of-contents__link toc-highlight">一、JavaScript 单线程机制</a></li><li><a href="#二同步任务和异步任务" class="table-of-contents__link toc-highlight">二、同步任务和异步任务</a></li><li><a href="#三什么是事件循环" class="table-of-contents__link toc-highlight">三、什么是事件循环</a></li><li><a href="#四宏任务与微任务" class="table-of-contents__link toc-highlight">四、宏任务与微任务</a></li><li><a href="#五async-与-await" class="table-of-contents__link toc-highlight">五、async 与 await</a><ul><li><a href="#async" class="table-of-contents__link toc-highlight">async</a></li><li><a href="#await" class="table-of-contents__link toc-highlight">await</a></li></ul></li><li><a href="#六node-和浏览器事件循环机制有何不同" class="table-of-contents__link toc-highlight">六、Node 和浏览器事件循环机制有何不同</a><ul><li><a href="#1-线程与进程" class="table-of-contents__link toc-highlight">1. 线程与进程</a></li><li><a href="#2-浏览器中的-event-loop" class="table-of-contents__link toc-highlight">2. 浏览器中的 Event Loop</a></li><li><a href="#3-node-中的-event-loop" class="table-of-contents__link toc-highlight">3. Node 中的 Event Loop</a></li><li><a href="#4-node-与浏览器的-event-loop-差异" class="table-of-contents__link toc-highlight">4. Node 与浏览器的 Event Loop 差异</a></li></ul></li><li><a href="#七流程分析" class="table-of-contents__link toc-highlight">七、流程分析</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.ffc5e5a1.js"></script>
<script src="/assets/js/main.8fee9b7a.js"></script>
</body>
</html>