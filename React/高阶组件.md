ğŸ·: #react #é«˜é˜¶ç»„ä»¶
***

## ä¸€ã€æ˜¯ä»€ä¹ˆ

é«˜é˜¶å‡½æ•°ï¼ˆHigher-order functionï¼‰ï¼Œè‡³å°‘æ»¡è¶³ä¸‹åˆ—ä¸€ä¸ªæ¡ä»¶çš„å‡½æ•°

- æ¥å—ä¸€ä¸ªæˆ–å¤šä¸ªå‡½æ•°ä½œä¸ºè¾“å…¥
- è¾“å‡ºä¸€ä¸ªå‡½æ•°

åœ¨`React`ä¸­ï¼Œé«˜é˜¶ç»„ä»¶å³æ¥å—ä¸€ä¸ªæˆ–å¤šä¸ªç»„ä»¶ä½œä¸ºå‚æ•°å¹¶ä¸”è¿”å›ä¸€ä¸ªç»„ä»¶ï¼Œæœ¬è´¨ä¹Ÿå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªç»„ä»¶

```jsx
const EnhancedComponent = highOrderComponent(WrappedComponent);
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªç»„ä»¶`WrappedComponent`ä½œä¸ºå‚æ•°ï¼Œè¿”å›åŠ å·¥è¿‡çš„æ–°ç»„ä»¶`EnhancedComponent`

é«˜é˜¶ç»„ä»¶çš„è¿™ç§å®ç°æ–¹å¼ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè£…é¥°è€…è®¾è®¡æ¨¡å¼

## äºŒã€å¦‚ä½•ç¼–å†™

æœ€åŸºæœ¬çš„é«˜é˜¶ç»„ä»¶çš„ç¼–å†™æ¨¡æ¿å¦‚ä¸‹ï¼š

```jsx
import React, { Component } from 'react';

export default (WrappedComponent) => {
  return class EnhancedComponent extends Component {
    // do something
    render() {
      return <WrappedComponent />;
    }
  }
}
```

é€šè¿‡å¯¹ä¼ å…¥çš„åŸå§‹ç»„ä»¶ `WrappedComponent` åšä¸€äº›ä½ æƒ³è¦çš„æ“ä½œï¼ˆæ¯”å¦‚æ“ä½œ propsï¼Œæå– stateï¼Œç»™åŸå§‹ç»„ä»¶åŒ…è£¹å…¶ä»–å…ƒç´ ç­‰ï¼‰ï¼Œä»è€ŒåŠ å·¥å‡ºæƒ³è¦çš„ç»„ä»¶ `EnhancedComponent`

æŠŠé€šç”¨çš„é€»è¾‘æ”¾åœ¨é«˜é˜¶ç»„ä»¶ä¸­ï¼Œå¯¹ç»„ä»¶å®ç°ä¸€è‡´çš„å¤„ç†ï¼Œä»è€Œå®ç°ä»£ç çš„å¤ç”¨

æ‰€ä»¥ï¼Œé«˜é˜¶ç»„ä»¶çš„ä¸»è¦åŠŸèƒ½æ˜¯å°è£…å¹¶åˆ†ç¦»ç»„ä»¶çš„é€šç”¨é€»è¾‘ï¼Œè®©é€šç”¨é€»è¾‘åœ¨ç»„ä»¶é—´æ›´å¥½åœ°è¢«å¤ç”¨

ä½†åœ¨ä½¿ç”¨é«˜é˜¶ç»„ä»¶çš„åŒæ—¶ï¼Œä¸€èˆ¬éµå¾ªä¸€äº›çº¦å®šï¼Œå¦‚ä¸‹ï¼š

- props ä¿æŒä¸€è‡´
- ä½ ä¸èƒ½åœ¨å‡½æ•°å¼ï¼ˆæ— çŠ¶æ€ï¼‰ç»„ä»¶ä¸Šä½¿ç”¨ ref å±æ€§ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å®ä¾‹
- ä¸è¦ä»¥ä»»ä½•æ–¹å¼æ”¹å˜åŸå§‹ç»„ä»¶ WrappedComponent
- é€ä¼ ä¸ç›¸å…³ props å±æ€§ç»™è¢«åŒ…è£¹çš„ç»„ä»¶ WrappedComponent
- ä¸è¦å† render() æ–¹æ³•ä¸­ä½¿ç”¨é«˜é˜¶ç»„ä»¶
- ä½¿ç”¨  compose ç»„åˆé«˜é˜¶ç»„ä»¶
- åŒ…è£…æ˜¾ç¤ºåå­—ä»¥ä¾¿äºè°ƒè¯•

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé«˜é˜¶ç»„ä»¶å¯ä»¥ä¼ é€’æ‰€æœ‰çš„`props`ï¼Œä½†æ˜¯ä¸èƒ½ä¼ é€’`ref`

å¦‚æœå‘ä¸€ä¸ªé«˜é˜¶ç»„ä»¶æ·»åŠ `refe`å¼•ç”¨ï¼Œé‚£ä¹ˆ`ref` æŒ‡å‘çš„æ˜¯æœ€å¤–å±‚å®¹å™¨ç»„ä»¶å®ä¾‹çš„ï¼Œè€Œä¸æ˜¯è¢«åŒ…è£¹çš„ç»„ä»¶ï¼Œå¦‚æœéœ€è¦ä¼ é€’`refs`çš„è¯ï¼Œåˆ™ä½¿ç”¨`React.forwardRef`ï¼Œå¦‚ä¸‹ï¼š

```jsx
function withLogging(WrappedComponent) {
    class Enhance extends WrappedComponent {
        componentWillReceiveProps() {
            console.log('Current props', this.props);
            console.log('Next props', nextProps);
        }
        render() {
            const {forwardedRef, ...rest} = this.props;
            // æŠŠ forwardedRef èµ‹å€¼ç»™ ref
            return <WrappedComponent {...rest} ref={forwardedRef} />;
        }
    };

    // React.forwardRef æ–¹æ³•ä¼šä¼ å…¥ props å’Œ ref ä¸¤ä¸ªå‚æ•°ç»™å…¶å›è°ƒå‡½æ•°
    // æ‰€ä»¥è¿™è¾¹çš„ ref æ˜¯ç”± React.forwardRef æä¾›çš„
    function forwardRef(props, ref) {
        return <Enhance {...props} forwardRef={ref} />
    }

    return React.forwardRef(forwardRef);
}
const EnhancedComponent = withLogging(SomeComponent);
```


## ä¸‰ã€åº”ç”¨åœºæ™¯

é€šè¿‡ä¸Šé¢çš„äº†è§£ï¼Œé«˜é˜¶ç»„ä»¶èƒ½å¤Ÿæé«˜ä»£ç çš„å¤ç”¨æ€§å’Œçµæ´»æ€§ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¸¸å¸¸ç”¨äºä¸æ ¸å¿ƒä¸šåŠ¡æ— å…³ä½†åˆåœ¨å¤šä¸ªæ¨¡å—ä½¿ç”¨çš„åŠŸèƒ½ï¼Œå¦‚æƒé™æ§åˆ¶ã€æ—¥å¿—è®°å½•ã€æ•°æ®æ ¡éªŒã€å¼‚å¸¸å¤„ç†ã€ç»Ÿè®¡ä¸ŠæŠ¥ç­‰

ä¸¾ä¸ªä¾‹å­ï¼Œå­˜åœ¨ä¸€ä¸ªç»„ä»¶ï¼Œéœ€è¦ä»ç¼“å­˜ä¸­è·å–æ•°æ®ï¼Œç„¶åæ¸²æŸ“ã€‚ä¸€èˆ¬æƒ…å†µï¼Œæˆ‘ä»¬ä¼šå¦‚ä¸‹ç¼–å†™ï¼š

```jsx
import React, { Component } from 'react'

class MyComponent extends Component {

  componentWillMount() {
      let data = localStorage.getItem('data');
      this.setState({data});
  }
  
  render() {
    return <div>{this.state.data}</div>
  }
}
```

ä¸Šè¿°ä»£ç å½“ç„¶å¯ä»¥å®ç°è¯¥åŠŸèƒ½ï¼Œä½†æ˜¯å¦‚æœè¿˜æœ‰å…¶ä»–ç»„ä»¶ä¹Ÿæœ‰ç±»ä¼¼åŠŸèƒ½çš„æ—¶å€™ï¼Œæ¯ä¸ªç»„ä»¶éƒ½éœ€è¦é‡å¤å†™`componentWillMount`ä¸­çš„ä»£ç ï¼Œè¿™æ˜æ˜¾æ˜¯å†—æ‚çš„

ä¸‹é¢å°±å¯ä»¥é€šè¿‡é«˜ä»·ç»„ä»¶æ¥è¿›è¡Œæ”¹å†™ï¼Œå¦‚ä¸‹ï¼š

```jsx
import React, { Component } from 'react'

function withPersistentData(WrappedComponent) {
  return class extends Component {
    componentWillMount() {
      let data = localStorage.getItem('data');
        this.setState({data});
    }
    
    render() {
      // é€šè¿‡{...this.props} æŠŠä¼ é€’ç»™å½“å‰ç»„ä»¶çš„å±æ€§ç»§ç»­ä¼ é€’ç»™è¢«åŒ…è£…çš„ç»„ä»¶WrappedComponent
      return <WrappedComponent data={this.state.data} {...this.props} />
    }
  }
}

class MyComponent2 extends Component {  
  render() {
    return <div>{this.props.data}</div>
  }
}

const MyComponentWithPersistentData = withPersistentData(MyComponent2)
```

å†æ¯”å¦‚ç»„ä»¶æ¸²æŸ“æ€§èƒ½ç›‘æ§ï¼Œå¦‚ä¸‹ï¼š

```jsx
class Home extends React.Component {
    render() {
        return (<h1>Hello World.</h1>);
    }
}
function withTiming(WrappedComponent) {
    return class extends WrappedComponent {
        constructor(props) {
            super(props);
            this.start = 0;
            this.end = 0;
        }
        componentWillMount() {
            super.componentWillMount && super.componentWillMount();
            this.start = Date.now();
        }
        componentDidMount() {
            super.componentDidMount && super.componentDidMount();
            this.end = Date.now();
            console.log(`${WrappedComponent.name} ç»„ä»¶æ¸²æŸ“æ—¶é—´ä¸º ${this.end - this.start} ms`);
        }
        render() {
            return super.render();
        }
    };
}

export default withTiming(Home);
```


## å‚è€ƒæ–‡çŒ®

- https://zh-hans.reactjs.org/docs/higher-order-components.html#gatsby-focus-wrapper
- https://zh.wikipedia.org/wiki/%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0
- https://segmentfault.com/a/1190000010307650
- https://zhuanlan.zhihu.com/p/61711492
